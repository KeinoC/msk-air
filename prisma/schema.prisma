generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Location {
  id        String   @id @default(cuid())
  name      String?
  address   String?
  city      String?
  state     String?
  country   String?
  zipCode   String?
  latitude  Float?
  longitude Float?
  timezone  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sensors Sensor[]

  @@map("locations")
}

model Sensor {
  id              String   @id
  serialNumber    String?
  name            String?
  locationId      String?
  locationName    String?
  wifiSsid        String?
  pm25            Float?
  pm01            Float?
  pm10            Float?
  pm03PCount      Float?
  atmp            Float?
  rhum            Float?
  rco2            Float?
  tvoc            Float?
  nox             Float?
  wifi            Float?
  boot            Float?
  model           String?
  firmwareVersion String?
  ledBarTest      String?
  date            String?
  timestamp       Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  location        Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  measurements    Measurement[]
  alerts          Alert[]
  configurations  Configuration[]

  @@map("sensors")
}

model Measurement {
  id              String   @id @default(uuid())
  sensorId        String?
  serialNumber    String?
  
  // Location fields (from measure API)
  locationId      Int?
  locationName    String?
  locationType    String?
  
  // PM measurements - raw
  pm01            Float?
  pm02            Float?  // This is pm25 in API
  pm10            Float?
  pm03PCount      Float?
  
  // PM measurements - corrected
  pm01_corrected  Float?
  pm02_corrected  Float?  // This is pm25_corrected in API
  pm10_corrected  Float?
  
  // Environmental - raw
  atmp            Float?
  rhum            Float?
  rco2            Float?
  
  // Environmental - corrected
  atmp_corrected  Float?
  rhum_corrected  Float?
  rco2_corrected  Float?
  
  // VOC and other indices
  tvoc            Float?
  tvocIndex       Float?
  noxIndex        Float?
  
  // Sensor info
  wifi            Float?
  boot            Float?
  model           String?
  firmwareVersion String?
  datapoints      Int?     // For aggregated data
  
  // Location coordinates
  longitude       Float?
  latitude        Float?
  
  // Timestamps
  date            String?
  timestamp       Int?     // Converted from ISO string
  createdAt       DateTime @default(now())

  sensor Sensor? @relation(fields: [sensorId], references: [id], onDelete: SetNull)

  @@index([sensorId])
  @@index([serialNumber])
  @@index([timestamp])
  @@index([createdAt])
  @@index([locationId])
  @@map("measurements")
}

enum AlertSeverity {
  low
  medium
  high
  critical
}

model Alert {
  id           String        @id
  sensorId     String?
  serialNumber String?
  type         String?
  severity     AlertSeverity?
  message      String?
  threshold    Float?
  currentValue Float?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  resolvedAt   DateTime?

  sensor Sensor? @relation(fields: [sensorId], references: [id], onDelete: SetNull)

  @@index([sensorId])
  @@index([serialNumber])
  @@index([isActive])
  @@map("alerts")
}

model Configuration {
  id           String   @id
  sensorId     String?
  serialNumber String?
  key          String?
  value        Json?
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sensor Sensor? @relation(fields: [sensorId], references: [id], onDelete: SetNull)

  @@index([sensorId])
  @@index([serialNumber])
  @@index([key])
  @@map("configurations")
}

